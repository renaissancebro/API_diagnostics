<!DOCTYPE html>
<html>
<head>
    <title>API Diagnostics Interceptor Test</title>
</head>
<body>
    <h1>API Diagnostics Interceptor Test</h1>
    <button onclick="testSuccessfulRequest()">Test Successful Request</button>
    <button onclick="testErrorRequest()">Test Error Request</button>
    <button onclick="testNetworkError()">Test Network Error</button>

    <script>
// API Diagnostics Interceptor - Auto-generated
// This code automatically adds correlation IDs to all fetch() calls

(function() {
  'use strict';

  // Generate UUID4 (no external dependencies)
  function generateCorrelationId() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      const r = Math.random() * 16 | 0;
      const v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }

  // Format correlation ID for display (first 8 chars)
  function formatCorrelationId(id) {
    return id.substring(0, 8);
  }

  // Enhanced console logging
  function logRequest(correlationId, url, method, timestamp) {
    console.group(`üîç [${formatCorrelationId(correlationId)}] ${method} ${url}`);
    console.log('Full Correlation ID:', correlationId);
    console.log('Timestamp:', timestamp);
    console.log('Method:', method);
    console.log('URL:', url);
    console.groupEnd();
  }

  function logError(correlationId, url, status, statusText, timestamp) {
    console.group(`‚ùå [${formatCorrelationId(correlationId)}] ${status} ${statusText}`);
    console.error('Full Correlation ID:', correlationId);
    console.error('URL:', url);
    console.error('Status:', status, statusText);
    console.error('Timestamp:', timestamp);
    console.error('üîß Search backend logs with: api-diagnostics search', correlationId);
    console.groupEnd();
  }

  function logNetworkError(correlationId, url, error, timestamp) {
    console.group(`üö´ [${formatCorrelationId(correlationId)}] Network Error`);
    console.error('Full Correlation ID:', correlationId);
    console.error('URL:', url);
    console.error('Error:', error.message);
    console.error('Timestamp:', timestamp);
    console.error('üîß Search backend logs with: api-diagnostics search', correlationId);
    console.groupEnd();
  }

  // Store original fetch
  const originalFetch = window.fetch;

  // Override fetch with correlation tracking
  window.fetch = async function(url, options = {}) {
    const correlationId = generateCorrelationId();
    const timestamp = new Date().toISOString();
    const method = options.method || 'GET';

    // Add correlation ID to headers
    const headers = {
      ...options.headers,
      'X-Correlation-ID': correlationId
    };

    // Log outgoing request
    logRequest(correlationId, url, method, timestamp);

    try {
      const response = await originalFetch(url, { ...options, headers });

      if (!response.ok) {
        logError(correlationId, url, response.status, response.statusText, timestamp);
      } else {
        console.log(`‚úÖ [${formatCorrelationId(correlationId)}] ${response.status} ${response.statusText}`);
      }

      return response;
    } catch (error) {
      logNetworkError(correlationId, url, error, timestamp);
      throw error;
    }
  };

  console.log('üîç API Diagnostics interceptor loaded - all fetch() calls will include correlation IDs');
})();

// Test functions
async function testSuccessfulRequest() {
    try {
        const response = await fetch('https://jsonplaceholder.typicode.com/posts/1');
        const data = await response.json();
        console.log('Response data:', data);
    } catch (error) {
        console.error('Request failed:', error);
    }
}

async function testErrorRequest() {
    try {
        const response = await fetch('https://jsonplaceholder.typicode.com/posts/999999');
        const data = await response.json();
        console.log('Response data:', data);
    } catch (error) {
        console.error('Request failed:', error);
    }
}

async function testNetworkError() {
    try {
        const response = await fetch('https://nonexistent-domain-12345.com/api');
        const data = await response.json();
        console.log('Response data:', data);
    } catch (error) {
        console.error('Request failed:', error);
    }
}
    </script>
</body>
</html>
